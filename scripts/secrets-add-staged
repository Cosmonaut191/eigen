#!/usr/bin/env yarn zx


// This script runs to add secrets from staged files to the baseline file.


import {startSpinner} from 'zx/experimental'


const stagedFiles = (await $`git diff --staged --name-only`).stdout
const stagedFilesList = stagedFiles.split("\n")
stagedFilesList.pop() // remove last empty line

const stop = startSpinner()
// in the following command we exclude some files:
// - lock files, they are large and full of hashes, not containing any secrets of ours.
// - png,webp,jpg image files, no secrets, just images.
// - jar files, there is just one from RN, and it's not ours, so we can skip it.
// - relay __generated__ files, these all are generated from src files,
//   so if secrets are in there, they are in src files as well, and we should catch it there.
await $`detect-secrets scan       \
  --exclude-files /\.lock$/       \
  --exclude-files /\.png$/        \
  --exclude-files /\.webp$/       \
  --exclude-files /\.jpg$/        \
  --exclude-files /\.jar$/        \
  --exclude-files /__generated__/ \
  --baseline .secrets.baseline    \
  ${stagedFilesList}`
stop()
